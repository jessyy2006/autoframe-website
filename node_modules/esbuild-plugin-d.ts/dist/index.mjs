var h=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,i)=>(typeof require<"u"?require:e)[i]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});import{createHash as E}from"crypto";import{resolve as x}from"path";import H from"typescript";function v(t){var i,r,l,c;let e=H.convertCompilerOptionsFromJson(t.tsconfig.compilerOptions,process.cwd()).options;if(e.declaration=!0,e.emitDeclarationOnly=!0,e.declarationDir||(e.declarationDir=(r=(i=e.declarationDir)!=null?i:t.esbuildOptions.outdir)!=null?r:e.outDir),t.willBundleDeclarations&&(e.declarationDir=x(e.declarationDir,"dts-prebundle")),e.incremental&&!e.tsBuildInfoFile){let o=E("sha256").update(JSON.stringify({compilerOptions:e,__buildContext:(l=t.pluginOptions)==null?void 0:l.__buildContext})).digest("hex"),m=x(h.resolve("esbuild/package.json"),"../../.cache/esbuild-plugin-d.ts");e.tsBuildInfoFile=x((c=t.pluginOptions.buildInfoDir)!=null?c:m,`esbuild-plugin-dts-${o}.tsbuildinfo`)}return e.listEmittedFiles=!0,e}import _ from"lodash.merge";import{readFileSync as k}from"fs";import{dirname as z,resolve as j}from"path";import O from"typescript";function A(t){try{return h.resolve(t)}catch{return}}function P(t){var r,l,c;let e=(l=t.configPath)!=null?l:O.findConfigFile((r=t.searchPath)!=null?r:process.cwd(),O.sys.fileExists,t.configName);if(!e)throw new Error("No config file found");e.startsWith(".")&&(e=h.resolve(e));let i=O.readConfigFile(e,o=>k(o,"utf-8"));if(i.config.extends){let o=P({...t,configPath:(c=A(i.config.extends))!=null?c:j(z(e),i.config.extends)}).config;i.config=_(o,i.config)}if(i.error)throw i.error;return{config:i.config,configPath:e}}function F(t){let e=Math.floor(Math.log(t)/Math.log(1024));return Math.round(t/Math.pow(1024,e)*100)/100+["b","kb","mb","gb","tb"][e]}import b from"chalk";import{existsSync as G,lstatSync as K}from"fs";import{resolve as L}from"path";import g from"typescript";import{generateDtsBundle as q}from"dts-bundle-generator";import{randomBytes as J}from"crypto";import{rmSync as S,writeFileSync as w}from"fs";import{dirname as W,sep as C,resolve as y}from"path";function R(t){if(t.length===0)return"";if(t.length===1)return W(t[0]);let[e,...i]=t.map(l=>l.split(C)),r=e;for(let l of i)r=r.slice(0,r.findIndex((c,o)=>c!==l[o])||r.length);return r.join(C)}function B(t,e,i,r){let l=R(t),c=t.map(f=>f.replace(l+"/","").replace(/\.tsx?$/,".d.ts")),o=y(e.declarationDir,".."),m=!1;if(!i&&r){let f=J(6).toString("hex");i=y(process.cwd(),`tsconfig.${f}.json`),w(i,JSON.stringify({...r,compilerOptions:{...r.compilerOptions,declaration:!0,emitDeclarationOnly:!0,declarationDir:o},include:t})),m=!0}try{let f=q(c.map(a=>({filePath:y(e.declarationDir,a)})),{preferredConfigPath:i});for(let a=0;a<f.length;a++){let p=f[a],u=c[a],d=y(o,u);w(d,p)}e.declarationDir.endsWith("dts-prebundle")&&S(e.declarationDir,{recursive:!0}),m&&i&&S(i)}catch(f){throw m&&i&&S(i),f}}function T(t){let e=["verbose","debug","info","warning","error","silent"];for(let i of e){if(i===t)break;e.splice(e.indexOf(i),1)}return{info:(...i)=>{e.includes("info")&&console.log(...i)}}}var Q=(t={})=>({name:"dts-plugin",async setup(e){let i=T(e.initialOptions.logLevel),{config:r,configPath:l}=t.tsconfig&&typeof t.tsconfig!="string"?{config:t.tsconfig,configPath:void 0}:P({configPath:t.tsconfig}),c=!!t.experimentalBundling&&Array.isArray(e.initialOptions.entryPoints),o=v({tsconfig:r,pluginOptions:t,esbuildOptions:e.initialOptions,willBundleDeclarations:c}),m=o.incremental?g.createIncrementalCompilerHost(o):g.createCompilerHost(o),f=[];e.onLoad({filter:/(\.tsx|\.ts)$/},async a=>{var u;f.push(a.path);let p=[];return m.getSourceFile(a.path,(u=o.target)!=null?u:g.ScriptTarget.Latest,d=>{p.push({detail:d})},!0),{errors:p}}),e.onEnd(()=>{let a;o.incremental?a=g.createIncrementalProgram({options:o,host:m,rootNames:f}):a=g.createProgram(f,o,m);let p=g.getPreEmitDiagnostics(a).map(n=>{var s;return{text:typeof n.messageText=="string"?n.messageText:n.messageText.messageText,detail:n,location:{file:(s=n.file)==null?void 0:s.fileName,namespace:"file"},category:n.category}}),u=p.filter(n=>n.category===g.DiagnosticCategory.Error).map(({category:n,...s})=>s),d=p.filter(n=>n.category===g.DiagnosticCategory.Warning).map(({category:n,...s})=>s);if(u.length>0)return{errors:u,warnings:d};let M=Date.now(),D=a.emit();if(c){let n=[];Array.isArray(e.initialOptions.entryPoints)?n=e.initialOptions.entryPoints.map(s=>typeof s=="string"?s:s.in):n=Object.values(e.initialOptions.entryPoints),B(n,o,l,r)}if(D.emitSkipped||typeof D.emittedFiles>"u")i.info(b`{yellow No declarations emitted}`);else for(let n of D.emittedFiles){let s=L(n);if(G(s)&&s!==o.tsBuildInfoFile){let N=K(s),I=s.replace(L(process.cwd()),"").replace(/^[\\/]/,""),$=F(N.size);i.info(b`  {bold ${I}} {cyan ${$}}`)}}return i.info(b`{green Finished compiling declarations in ${Date.now()-M}ms}`),{warnings:d}})}});export{Q as default,Q as dtsPlugin,v as getCompilerOptions,F as humanizeFileSize,P as resolveTSConfig};
//# sourceMappingURL=index.mjs.map