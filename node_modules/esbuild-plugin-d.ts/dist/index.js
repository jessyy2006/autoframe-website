var W=Object.create;var x=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var G=Object.getOwnPropertyNames;var K=Object.getPrototypeOf,Q=Object.prototype.hasOwnProperty;var U=(t,e)=>{for(var i in e)x(t,i,{get:e[i],enumerable:!0})},L=(t,e,i,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of G(e))!Q.call(t,n)&&n!==i&&x(t,n,{get:()=>e[n],enumerable:!(r=R(e,n))||r.enumerable});return t};var D=(t,e,i)=>(i=t!=null?W(K(t)):{},L(e||!t||!t.__esModule?x(i,"default",{value:t,enumerable:!0}):i,t)),V=t=>L(x({},"__esModule",{value:!0}),t);var Z={};U(Z,{default:()=>k,dtsPlugin:()=>k,getCompilerOptions:()=>C,humanizeFileSize:()=>B,resolveTSConfig:()=>v});module.exports=V(Z);var M=require("crypto"),O=require("path"),N=D(require("typescript"));function C(t){var i,r,n,c;let e=N.default.convertCompilerOptionsFromJson(t.tsconfig.compilerOptions,process.cwd()).options;if(e.declaration=!0,e.emitDeclarationOnly=!0,e.declarationDir||(e.declarationDir=(r=(i=e.declarationDir)!=null?i:t.esbuildOptions.outdir)!=null?r:e.outDir),t.willBundleDeclarations&&(e.declarationDir=(0,O.resolve)(e.declarationDir,"dts-prebundle")),e.incremental&&!e.tsBuildInfoFile){let o=(0,M.createHash)("sha256").update(JSON.stringify({compilerOptions:e,__buildContext:(n=t.pluginOptions)==null?void 0:n.__buildContext})).digest("hex"),g=(0,O.resolve)(require.resolve("esbuild/package.json"),"../../.cache/esbuild-plugin-d.ts");e.tsBuildInfoFile=(0,O.resolve)((c=t.pluginOptions.buildInfoDir)!=null?c:g,`esbuild-plugin-dts-${o}.tsbuildinfo`)}return e.listEmittedFiles=!0,e}var I=D(require("lodash.merge")),$=require("fs"),S=require("path"),P=D(require("typescript"));function X(t){try{return require.resolve(t)}catch{return}}function v(t){var r,n,c;let e=(n=t.configPath)!=null?n:P.default.findConfigFile((r=t.searchPath)!=null?r:process.cwd(),P.default.sys.fileExists,t.configName);if(!e)throw new Error("No config file found");e.startsWith(".")&&(e=require.resolve(e));let i=P.default.readConfigFile(e,o=>(0,$.readFileSync)(o,"utf-8"));if(i.config.extends){let o=v({...t,configPath:(c=X(i.config.extends))!=null?c:(0,S.resolve)((0,S.dirname)(e),i.config.extends)}).config;i.config=(0,I.default)(o,i.config)}if(i.error)throw i.error;return{config:i.config,configPath:e}}function B(t){let e=Math.floor(Math.log(t)/Math.log(1024));return Math.round(t/Math.pow(1024,e)*100)/100+["b","kb","mb","gb","tb"][e]}var b=D(require("chalk")),F=require("fs"),T=require("path"),p=D(require("typescript"));var E=require("dts-bundle-generator"),H=require("crypto"),h=require("fs"),m=require("path");function Y(t){if(t.length===0)return"";if(t.length===1)return(0,m.dirname)(t[0]);let[e,...i]=t.map(n=>n.split(m.sep)),r=e;for(let n of i)r=r.slice(0,r.findIndex((c,o)=>c!==n[o])||r.length);return r.join(m.sep)}function _(t,e,i,r){let n=Y(t),c=t.map(f=>f.replace(n+"/","").replace(/\.tsx?$/,".d.ts")),o=(0,m.resolve)(e.declarationDir,".."),g=!1;if(!i&&r){let f=(0,H.randomBytes)(6).toString("hex");i=(0,m.resolve)(process.cwd(),`tsconfig.${f}.json`),(0,h.writeFileSync)(i,JSON.stringify({...r,compilerOptions:{...r.compilerOptions,declaration:!0,emitDeclarationOnly:!0,declarationDir:o},include:t})),g=!0}try{let f=(0,E.generateDtsBundle)(c.map(l=>({filePath:(0,m.resolve)(e.declarationDir,l)})),{preferredConfigPath:i});for(let l=0;l<f.length;l++){let u=f[l],d=c[l],y=(0,m.resolve)(o,d);(0,h.writeFileSync)(y,u)}e.declarationDir.endsWith("dts-prebundle")&&(0,h.rmSync)(e.declarationDir,{recursive:!0}),g&&i&&(0,h.rmSync)(i)}catch(f){throw g&&i&&(0,h.rmSync)(i),f}}function z(t){let e=["verbose","debug","info","warning","error","silent"];for(let i of e){if(i===t)break;e.splice(e.indexOf(i),1)}return{info:(...i)=>{e.includes("info")&&console.log(...i)}}}var k=(t={})=>({name:"dts-plugin",async setup(e){let i=z(e.initialOptions.logLevel),{config:r,configPath:n}=t.tsconfig&&typeof t.tsconfig!="string"?{config:t.tsconfig,configPath:void 0}:v({configPath:t.tsconfig}),c=!!t.experimentalBundling&&Array.isArray(e.initialOptions.entryPoints),o=C({tsconfig:r,pluginOptions:t,esbuildOptions:e.initialOptions,willBundleDeclarations:c}),g=o.incremental?p.default.createIncrementalCompilerHost(o):p.default.createCompilerHost(o),f=[];e.onLoad({filter:/(\.tsx|\.ts)$/},async l=>{var d;f.push(l.path);let u=[];return g.getSourceFile(l.path,(d=o.target)!=null?d:p.default.ScriptTarget.Latest,y=>{u.push({detail:y})},!0),{errors:u}}),e.onEnd(()=>{let l;o.incremental?l=p.default.createIncrementalProgram({options:o,host:g,rootNames:f}):l=p.default.createProgram(f,o,g);let u=p.default.getPreEmitDiagnostics(l).map(s=>{var a;return{text:typeof s.messageText=="string"?s.messageText:s.messageText.messageText,detail:s,location:{file:(a=s.file)==null?void 0:a.fileName,namespace:"file"},category:s.category}}),d=u.filter(s=>s.category===p.default.DiagnosticCategory.Error).map(({category:s,...a})=>a),y=u.filter(s=>s.category===p.default.DiagnosticCategory.Warning).map(({category:s,...a})=>a);if(d.length>0)return{errors:d,warnings:y};let A=Date.now(),w=l.emit();if(c){let s=[];Array.isArray(e.initialOptions.entryPoints)?s=e.initialOptions.entryPoints.map(a=>typeof a=="string"?a:a.in):s=Object.values(e.initialOptions.entryPoints),_(s,o,n,r)}if(w.emitSkipped||typeof w.emittedFiles>"u")i.info(b.default`{yellow No declarations emitted}`);else for(let s of w.emittedFiles){let a=(0,T.resolve)(s);if((0,F.existsSync)(a)&&a!==o.tsBuildInfoFile){let j=(0,F.lstatSync)(a),q=a.replace((0,T.resolve)(process.cwd()),"").replace(/^[\\/]/,""),J=B(j.size);i.info(b.default`  {bold ${q}} {cyan ${J}}`)}}return i.info(b.default`{green Finished compiling declarations in ${Date.now()-A}ms}`),{warnings:y}})}});0&&(module.exports={dtsPlugin,getCompilerOptions,humanizeFileSize,resolveTSConfig});
//# sourceMappingURL=index.js.map